name: Publish Devcontainer Feature

on:
  release:
    types: [published]
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened, closed]  # Include closed for cleanup
  workflow_call:  # Allow calling from other workflows
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish the feature to GHCR"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: read

jobs:
  # Cleanup PR preview versions when PR is closed
  cleanup:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Delete PR preview package version
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const version = `0.0.0-pr.${prNumber}`;
            const packageName = 'features/devcontainer-credprovider';
            
            console.log(`ðŸ§¹ Cleaning up preview version: ${version}`);
            
            try {
              // List package versions to find the one matching our PR
              const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                package_type: 'container',
                package_name: packageName,
                username: context.repo.owner,
                per_page: 100
              });
              
              const prVersion = versions.data.find(v => 
                v.metadata?.container?.tags?.includes(version)
              );
              
              if (prVersion) {
                await github.rest.packages.deletePackageVersionForUser({
                  package_type: 'container',
                  package_name: packageName,
                  username: context.repo.owner,
                  package_version_id: prVersion.id
                });
                console.log(`âœ… Deleted preview version ${version}`);
              } else {
                console.log(`â„¹ï¸ No preview version found for ${version}`);
              }
            } catch (error) {
              // Don't fail the workflow if cleanup fails
              console.log(`âš ï¸ Could not delete preview version: ${error.message}`);
            }
      
      - name: Summary
        run: |
          echo "## ðŸ§¹ PR Preview Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Cleaned up preview version \`0.0.0-pr.${{ github.event.pull_request.number }}\`" >> $GITHUB_STEP_SUMMARY

  publish:
    if: github.event_name != 'pull_request' || github.event.action != 'closed'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write  # For PR comments
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-tags: true
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup .NET
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Build credential provider
        id: build
        run: |
          dotnet restore src/CredentialProvider.Devcontainer
          dotnet publish src/CredentialProvider.Devcontainer \
            -c Release \
            -o ./publish/netcore
          
          # Extract version from the built assembly (set by MinVer)
          BASE_VERSION=$(dotnet ./publish/netcore/CredentialProvider.Devcontainer.dll --version | awk '{print $2}' | cut -d'+' -f1)
          
          # For PRs, use a prerelease version to avoid overwriting stable releases
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            VERSION="0.0.0-pr.${{ github.event.pull_request.number }}"
            echo "ðŸ”§ PR build - using preview version: $VERSION"
          else
            VERSION="$BASE_VERSION"
            echo "ðŸ“¦ Release build - using version: $VERSION"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "base_version=$BASE_VERSION" >> $GITHUB_OUTPUT
          echo "is_pr=${{ github.event_name == 'pull_request' }}" >> $GITHUB_OUTPUT

      - name: Embed binaries in feature
        run: |
          # Create the binaries directory inside the feature
          FEATURE_DIR=".devcontainer-feature/src/devcontainer-credprovider"
          mkdir -p "$FEATURE_DIR/netcore"
          
          # Copy the built credential provider binaries
          cp -r ./publish/netcore/* "$FEATURE_DIR/netcore/"
          
          # Update feature version to match credential provider version
          VERSION="${{ steps.build.outputs.version }}"
          echo "ðŸ“¦ Setting feature version to: $VERSION"
          
          # Use jq to update the version in devcontainer-feature.json
          jq --arg v "$VERSION" '.version = $v' "$FEATURE_DIR/devcontainer-feature.json" > "$FEATURE_DIR/devcontainer-feature.json.tmp"
          mv "$FEATURE_DIR/devcontainer-feature.json.tmp" "$FEATURE_DIR/devcontainer-feature.json"
          
          # Show the updated feature config
          echo "ðŸ“„ Updated devcontainer-feature.json:"
          cat "$FEATURE_DIR/devcontainer-feature.json"
          
          # Show what's being embedded
          echo ""
          echo "ðŸ“¦ Embedded binaries:"
          ls -la "$FEATURE_DIR/netcore/"

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish feature
        run: |
          cd .devcontainer-feature
          devcontainer features publish \
            --registry ghcr.io \
            --namespace ${{ github.repository_owner }}/features \
            ./src
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ steps.build.outputs.version }}"
          FEATURE_REF="ghcr.io/${{ github.repository_owner }}/features/devcontainer-credprovider:$VERSION"
          
          echo "## ðŸ“¦ Devcontainer Feature Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **This is a PR preview build.** Use this version for testing only." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Add to your \`devcontainer.json\`:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "{" >> $GITHUB_STEP_SUMMARY
          echo "  \"features\": {" >> $GITHUB_STEP_SUMMARY
          echo "    \"$FEATURE_REF\": {}" >> $GITHUB_STEP_SUMMARY
          echo "  }" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
      
      - name: Add PR comment with feature reference
        if: github.event_name == 'pull_request'
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const version = '${{ steps.build.outputs.version }}';
            const featureRef = `ghcr.io/${{ github.repository_owner }}/features/devcontainer-credprovider:${version}`;
            
            const body = `## ðŸ§ª Devcontainer Feature Preview
            
            A preview version of the devcontainer feature has been published for testing.
            
            **Version:** \`${version}\`
            
            ### Test this PR
            
            Add to your \`devcontainer.json\`:
            
            \`\`\`json
            {
              "features": {
                "${featureRef}": {}
              }
            }
            \`\`\`
            
            > âš ï¸ This is a preview build. Do not use in production.`;
            
            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Devcontainer Feature Preview')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
