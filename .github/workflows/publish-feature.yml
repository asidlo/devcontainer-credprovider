name: Publish Devcontainer Feature

on:
  release:
    types: [published]
  workflow_call:  # Allow calling from other workflows
  workflow_dispatch:
    inputs:
      publish:
        description: "Publish the feature to GHCR"
        required: false
        default: true
        type: boolean

permissions:
  contents: read
  packages: read

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-tags: true
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@67a3573c9a986a3f9c594539f4ab511d57bb3ce9 # v4.3.1
        with:
          dotnet-version: "8.0.x"

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"

      - name: Install devcontainer CLI
        run: npm install -g @devcontainers/cli

      - name: Build credential provider
        id: build
        run: |
          dotnet restore src/CredentialProvider.Devcontainer
          dotnet publish src/CredentialProvider.Devcontainer \
            -c Release \
            -o ./publish/netcore
          
          # Extract version from the built assembly (set by MinVer)
          VERSION=$(dotnet ./publish/netcore/CredentialProvider.Devcontainer.dll --version | awk '{print $2}' | cut -d'+' -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Credential Provider Version: $VERSION"

      - name: Embed binaries in feature
        run: |
          # Create the binaries directory inside the feature
          FEATURE_DIR=".devcontainer-feature/src/devcontainer-credprovider"
          mkdir -p "$FEATURE_DIR/netcore"
          
          # Copy the built credential provider binaries
          cp -r ./publish/netcore/* "$FEATURE_DIR/netcore/"
          
          # Update feature version to match credential provider version
          VERSION="${{ steps.build.outputs.version }}"
          echo "ðŸ“¦ Setting feature version to: $VERSION"
          
          # Use jq to update the version in devcontainer-feature.json
          jq --arg v "$VERSION" '.version = $v' "$FEATURE_DIR/devcontainer-feature.json" > "$FEATURE_DIR/devcontainer-feature.json.tmp"
          mv "$FEATURE_DIR/devcontainer-feature.json.tmp" "$FEATURE_DIR/devcontainer-feature.json"
          
          # Show the updated feature config
          echo "ðŸ“„ Updated devcontainer-feature.json:"
          cat "$FEATURE_DIR/devcontainer-feature.json"
          
          # Show what's being embedded
          echo ""
          echo "ðŸ“¦ Embedded binaries:"
          ls -la "$FEATURE_DIR/netcore/"

      - name: Log in to GHCR
        uses: docker/login-action@74a5d142397b4f367a81961eba4e8cd7edddf772 # v3.4.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish feature
        run: |
          cd .devcontainer-feature
          devcontainer features publish \
            --registry ghcr.io \
            --namespace ${{ github.repository }} \
            ./src
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          VERSION="${{ steps.build.outputs.version }}"
          echo "## ðŸ“¦ Devcontainer Feature Published!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The feature is now available at:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "{" >> $GITHUB_STEP_SUMMARY
          echo "  \"features\": {" >> $GITHUB_STEP_SUMMARY
          echo "    \"ghcr.io/asidlo/features/devcontainer-credprovider\": {}" >> $GITHUB_STEP_SUMMARY
          echo "  }" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Or pin to this specific version:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "{" >> $GITHUB_STEP_SUMMARY
          echo "  \"features\": {" >> $GITHUB_STEP_SUMMARY
          echo "    \"ghcr.io/asidlo/features/devcontainer-credprovider:$VERSION\": {}" >> $GITHUB_STEP_SUMMARY
          echo "  }" >> $GITHUB_STEP_SUMMARY
          echo "}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
